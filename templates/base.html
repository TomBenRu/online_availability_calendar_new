<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Online Availability Days Calendar{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/remove-me.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            background-color: rgb(15 23 42);
            color: rgb(226 232 240);
        }
        
        /* Scrollbar-Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.7);
        }
        
        /* Animation für das Modal */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-animation {
            animation: fadeIn 0.3s, slideIn 0.3s;
        }
    </style>

    {% block head %}{% endblock %}
</head>
<body x-data class="min-h-screen bg-slate-900" hx-ext="remove-me">
    <div id="notification-container" class="fixed top-20 right-4 z-[100]"></div>
    <div id="modal-container" class="fixed inset-0 z-[200] flex items-center justify-center hidden"></div>
    
    <script>
        // Initialisiere HTMX Logging
        document.body.addEventListener('htmx:configRequest', function(evt) {
            console.log('HTMX request config:', evt.detail);
        });
        
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            console.log('HTMX before request:', {
                url: evt.detail.requestConfig.url,
                path: evt.detail.pathInfo ? evt.detail.pathInfo.requestPath : '',
                parameters: evt.detail.requestConfig.parameters
            });
        });
        
        document.body.addEventListener('htmx:beforeSend', function(evt) {
            console.log('HTMX before send:', evt.detail);
        });
        
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            console.log('HTMX after request:', evt.detail);
        });
        
        document.body.addEventListener('htmx:responseError', function(evt) {
            console.error('HTMX response error:', evt.detail);
        });
        
        document.body.addEventListener('htmx:sendError', function(evt) {
            console.error('HTMX send error:', evt.detail);
        });
        
        // Funktion, um HTMX im Modalen Inhalt zu verarbeiten
        function processModal() {
            console.log('Processing modal content');
            
            // Gib die komplette DOM-Struktur des Modals aus
            const modalContainer = document.getElementById('modal-container');
            const modalContent = modalContainer.querySelector('.p-4.max-w-md.w-full');
            console.log('Modal HTML:', modalContainer.innerHTML);
            console.log('Modal Content:', modalContent ? modalContent.innerHTML : 'not found');
            
            // Suche nach Buttons mit verschiedenen Selektoren
            const buttonsHx = modalContainer.querySelectorAll('[hx-post]');
            const buttonsDataHx = modalContainer.querySelectorAll('[data-hx-post]');
            console.log('Buttons with hx-post:', buttonsHx.length);
            console.log('Buttons with data-hx-post:', buttonsDataHx.length);
            
            if (modalContent) {
                htmx.process(modalContent);
            } else {
                console.error('Modal content element not found');
            }
        }
        
        // Separate Funktion für die Verarbeitung von Buttons
        function processButtons(buttons) {
            if (!buttons || buttons.length === 0) {
                console.log('Keine Buttons zum Verarbeiten gefunden.');
                return;
            }
            
            buttons.forEach((button, index) => {
                console.log(`Button ${index}:`, button.outerHTML);
                const postUrl = button.getAttribute('hx-post');
                const vals = button.getAttribute('hx-vals');
                const target = button.getAttribute('hx-target');
                const swap = button.getAttribute('hx-swap');
                
                // Entferne bestehende Event-Listener
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Füge neuen Event-Listener hinzu
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(`Manual button click on button ${index}`);
                    
                    // Parse vals
                    let valuesObj = {};
                    try {
                        if (vals) {
                            valuesObj = JSON.parse(vals.replace(/'/g, '"'));
                        }
                    } catch (err) {
                        console.error('Error parsing vals:', vals, err);
                    }
                    console.log('Parsed values:', valuesObj);
                    
                    // Manueller AJAX-Request
                    fetch(postUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'HX-Request': 'true',
                            'HX-Trigger': button.id || 'unknown',
                            'HX-Target': target || '',
                            'HX-Current-URL': window.location.href
                        },
                        body: new URLSearchParams(valuesObj)
                    })
                    .then(response => response.text())
                    .then(html => {
                        console.log('Received HTML response:', html);
                        const targetElem = document.querySelector(target);
                        if (targetElem) {
                            if (swap === 'outerHTML') {
                                targetElem.outerHTML = html;
                            } else {
                                targetElem.innerHTML = html;
                            }
                            
                            // Verarbeite HTMX in der Antwort
                            const parent = targetElem.parentNode;
                            if (parent) {
                                htmx.process(parent);
                                processModal(); // Rekursiver Aufruf für neue Buttons
                            }
                            console.log('Processed response HTML');
                        } else {
                            console.error('Target element not found:', target);
                        }
                    })
                    .catch(err => console.error('Error in manual fetch:', err));
                });
            });
        }
        
        // Funktion, um Timer zu verwenden und auf Alpine.js Rendering zu warten
        function initModal() {
            setTimeout(processModal, 100);
        }
        
        document.addEventListener('alpine:init', () => {
            Alpine.store('viewMode', {
                compact: false,
                calendarUrl: "{{ url_for('get_calendar_content') }}",
                toggle() {
                    this.compact = !this.compact;
                    console.log('Toggle clicked, compact:', this.compact);
                    console.log('Using URL:', this.calendarUrl);
                    // HTMX-Request mit direktem Parameter
                    htmx.ajax('GET', this.calendarUrl + '?compact=' + (this.compact ? '1' : '0'), {
                        target: '#calendar-container',
                        swap: 'innerHTML'
                    });
                }
            });
            
            Alpine.store('modal', {
                isOpen: false,
                content: '',
                
                open(content) {
                    this.content = content;
                    this.isOpen = true;
                    document.getElementById('modal-container').classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                    
                    // HTMX im Modal initialisieren
                    setTimeout(() => {
                        htmx.process(document.getElementById('modal-container'));
                    }, 10);
                },
                
                close() {
                    this.isOpen = false;
                    this.content = '';
                    document.getElementById('modal-container').classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            });
        });
        
        // Funktion zum Öffnen eines Modals mit HTMX-Inhalten
        function openModalWithHtmx(url, formData) {
            const modalContainer = document.getElementById('modal-container');
            
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                // Zuerst das Modal öffnen und HTML setzen
                Alpine.store('modal').open(html);
                
                // Warten bis das DOM aktualisiert wurde
                setTimeout(() => {
                    console.log('Verarbeite Modal nach Timeout');
                    const modalContent = document.querySelector('.p-4.max-w-md.w-full');
                    console.log('Modal Content gefunden:', modalContent ? 'ja' : 'nein');
                    if (modalContent) {
                        console.log('Modal HTML:', modalContent.innerHTML);
                        htmx.process(modalContent);
                        
                        // Debug: Buttons überprüfen
                        const buttons = modalContent.querySelectorAll('button[hx-post]');
                        console.log('Gefundene Buttons:', buttons.length);
                        buttons.forEach(btn => {
                            console.log('Button Attribute:', {
                                id: btn.id,
                                post: btn.getAttribute('hx-post'),
                                vals: btn.getAttribute('hx-vals')
                            });
                        });
                    }
                }, 100); // Längerer Timeout für sicheres Rendering
            })
            .catch(error => {
                console.error('Error loading modal content:', error);
            });
        }
        
        // Funktion zum Schließen des Modals
        function closeModal() {
            try {
                // Den Modal-Container leeren, um weitere Verarbeitungen zu vermeiden
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) {
                    // Speichere den Inhalt vor dem Leeren, um ihn in die Console zu schreiben
                    const oldContent = modalContainer.innerHTML;
                    if (oldContent && oldContent.trim() !== '') {
                        console.log('Schließe Modal und leere Inhalt.');
                    }
                    // Leere den Container
                    modalContainer.innerHTML = '';
                    modalContainer.classList.add('hidden');
                }
                
                // Versuche zuerst, den Alpine.js Store zu verwenden
                if (typeof Alpine !== 'undefined' && Alpine.store('modal')) {
                    Alpine.store('modal').close();
                } else {
                    // Fallback
                    const modalElement = document.querySelector('[x-data]');
                    if (modalElement && modalElement.__x) {
                        modalElement.__x.setData({ modalOpen: false, modalContent: '' });
                    }
                }
            } catch (error) {
                console.error('Fehler beim Schließen des Modals:', error);
                // Notfall-Fallback
                document.getElementById('modal-container').classList.add('hidden');
            }
        }
        
        // Event-Listener für ESC-Taste zum Schließen des Modals
        document.addEventListener('keydown', function(e) {
            const modalIsOpen = document.querySelector('[x-data]')?.__x?.getUnobservedData?.()?.modalOpen;
            const storeIsOpen = typeof Alpine !== 'undefined' && Alpine.store('modal')?.isOpen;
            
            if (e.key === 'Escape' && (modalIsOpen || storeIsOpen)) {
                closeModal();
            }
        });
    </script>
    
    <!-- Modal-Hintergrund mit click-away zum Schließen -->
    <div x-data="{ modalOpen: false, modalContent: '' }" 
         x-init="$watch('modalOpen', value => { if (value) { document.body.classList.add('overflow-hidden'); } else { document.body.classList.remove('overflow-hidden'); } })" 
         x-show="modalOpen || $store?.modal?.isOpen" 
         class="fixed inset-0 z-[200] bg-black bg-opacity-50 flex items-center justify-center"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click.self="modalOpen ? modalOpen = false : (typeof closeModal === 'function' && closeModal())">
        
        <!-- Modal-Inhalt -->
        <div class="bg-slate-800 rounded-lg shadow-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto modal-animation relative"
             @click.outside="modalOpen ? modalOpen = false : (typeof closeModal === 'function' && closeModal())">
             <div x-html="modalContent || ($store?.modal?.content || '')"></div>
        </div>
    </div>
    
    {% block content %}{% endblock %}

    {% block scripts %}{% endblock %}
</body>
</html>